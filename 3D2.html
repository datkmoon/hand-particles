<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic Particles - Camera 2</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; }
        #ui { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 100; }
        button { padding: 15px 30px; font-size: 18px; background: #00ff88; border: none; border-radius: 50px; cursor: pointer; color: black; font-weight: bold; }
        #info { position: absolute; bottom: 10px; width: 100%; text-align: center; color: white; font-size: 12px; opacity: 0.5; pointer-events: none; }
        video { display: none; }
    </style>
</head>
<body>

<div id="ui">
    <button id="start">تشغيل الكاميرا البديلة</button>
</div>
<div id="info">انقر على الشاشة لتغيير الشكل (عشوائي، قلب، زحل)</div>
<video id="input_video" playsinline></video>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

<script>
const particleCount = 1000;
let currentShape = 'random';
const targetPos = new Float32Array(particleCount * 3);

// --- إعداد Three.js ---
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ antialias: false });
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

const geometry = new THREE.BufferGeometry();
const positions = new Float32Array(particleCount * 3);
for(let i=0; i<particleCount*3; i++) positions[i] = (Math.random()-0.5)*10;
geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));

const material = new THREE.PointsMaterial({ size: 0.07, color: 0x00ff88, transparent: true });
const points = new THREE.Points(geometry, material);
scene.add(points);
camera.position.z = 5;

// --- منطق الأشكال ---
function setShape(type) {
    for (let i = 0; i < particleCount; i++) {
        const i3 = i * 3;
        if (type === 'heart') {
            const t = (i / particleCount) * Math.PI * 2;
            targetPos[i3] = 1.6 * Math.pow(Math.sin(t), 3);
            targetPos[i3+1] = 1.3 * Math.cos(t) - 0.5 * Math.cos(2*t) - 0.2 * Math.cos(3*t);
            targetPos[i3+2] = 0;
        } else if (type === 'saturn') {
            const t = (i / particleCount) * Math.PI * 2;
            if (i < 600) { 
                targetPos[i3] = Math.cos(t * 20) * Math.sin(t);
                targetPos[i3+1] = Math.sin(t * 20) * Math.sin(t);
                targetPos[i3+2] = Math.cos(t);
            } else { 
                targetPos[i3] = Math.cos(t) * 2.5;
                targetPos[i3+1] = Math.sin(t) * 0.5;
                targetPos[i3+2] = Math.sin(t) * 2.5;
            }
        } else {
            targetPos[i3] = (Math.random()-0.5)*5;
            targetPos[i3+1] = (Math.random()-0.5)*5;
            targetPos[i3+2] = (Math.random()-0.5)*5;
        }
    }
}

// --- تتبع اليد ---
const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
hands.setOptions({maxNumHands: 1, modelComplexity: 0});
hands.onResults(res => {
    if (res.multiHandLandmarks && res.multiHandLandmarks[0]) {
        const p = res.multiHandLandmarks[0][8];
        const tx = (p.x - 0.5
