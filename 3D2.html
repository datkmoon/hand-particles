<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>3D Hand Magic</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; }
        #ui { position: absolute; bottom: 20px; width: 100%; text-align: center; color: white; z-index: 10; pointer-events: none; }
        #btn { padding: 15px 30px; font-size: 18px; background: #00ff88; border: none; border-radius: 50px; cursor: pointer; pointer-events: auto; }
        #status { font-size: 12px; margin-top: 10px; opacity: 0.6; }
        video { display: none; }
    </style>
</head>
<body>

<div id="ui">
    <button id="btn">ابدأ التجربة</button>
    <div id="status">المس الشاشة لتغيير الشكل</div>
</div>
<video id="input_video" playsinline></video>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

<script>
let currentShape = 'random'; // الأشكال: random, heart, saturn, flower
const particleCount = 1500;
let targetPositions = new Float32Array(particleCount * 3);

// --- إعداد Three.js ---
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ antialias: false });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(window.devicePixelRatio > 1 ? 2 : 1);
document.body.appendChild(renderer.domElement);

const geometry = new THREE.BufferGeometry();
const posArray = new Float32Array(particleCount * 3);
for(let i=0; i<particleCount*3; i++) posArray[i] = (Math.random()-0.5)*10;

geometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
const material = new THREE.PointsMaterial({ size: 0.07, color: 0x00ff88, transparent: true, blending: THREE.AdditiveBlending });
const points = new THREE.Points(geometry, material);
scene.add(points);
camera.position.z = 5;

// --- توليد الأشكال ---
function generateShape(type) {
    for (let i = 0; i < particleCount; i++) {
        let x, y, z;
        const i3 = i * 3;
        const t = (i / particleCount) * Math.PI * 2;

        if (type === 'heart') {
            const angle = (i / particleCount) * Math.PI * 2;
            x = 1.6 * Math.pow(Math.sin(angle), 3);
            y = 1.3 * Math.cos(angle) - 0.5 * Math.cos(2*angle) - 0.2 * Math.cos(3*angle) - 0.1 * Math.cos(4*angle);
            z = (Math.random() - 0.5) * 0.5;
        } else if (type === 'saturn') {
            if (i < particleCount * 0.6) { // الكوكب
                const phi = Math.acos(-1 + (2 * i) / (particleCount * 0.6));
                const theta = Math.sqrt(particleCount * 0.6 * Math.PI) * phi;
                x = Math.cos(theta) * Math.sin(phi);
                y = Math.sin(theta) * Math.sin(phi);
                z = Math.cos(phi);
            } else { // الحلقات
                const r = 1.5 + Math.random() * 0.5;
                x = Math.cos(t * 10) * r;
                y = Math.sin(t * 10) * r * 0.3;
                z = Math.sin(t * 10) * r;
            }
        } else { // عشوائي
            x = (Math.random() - 0.5) * 5;
            y = (Math.random() - 0.5) * 5;
            z = (Math.random() - 0.5) * 5;
        }
        targetPositions[i3] = x;
        targetPositions[i3+1] = y;
        targetPositions[i3+2] = z;
    }
}

// --- تتبع اليد ---
const hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
hands.setOptions({ maxNumHands: 1, modelComplexity: 0, minDetectionConfidence: 0.5 });
hands.onResults(results => {
    if (results.multiHandLandmarks && results.multiHandLandmarks[0]) {
        const p = results.multiHandLandmarks[0][8];
        const tx = (p.x - 0.5) * -10, ty = (p.y - 0.5) * -10;
        moveParticles(tx, ty);
    }
});

function moveParticles(tx, ty) {
    const pos = geometry.attributes.position;
    for (let i = 0; i < particleCount; i++) {
        const i3 = i * 3;
        pos.array[i3] += (targetPositions[i3] + tx - pos.array[i3]) * 0.1;
        pos.array[i3+1] += (targetPositions[i3+1] + ty - pos.array[i3+1]) * 0.1;
        pos.array[i3+2] += (targetPositions[i3+2] - pos.array[i3+2]) * 0.1;
    }
    pos.needsUpdate = true;
}

// --- التحكم والتشغيل ---
document.body.addEventListener('click', () => {
    const shapes = ['random', 'heart', 'saturn'];
    currentShape = shapes[(shapes.indexOf(currentShape) + 1) % shapes.length];
    generateShape(currentShape);
    material.color.setHex(Math.random() * 0xffffff);
});

const videoElement = document.getElementById('input_video');
document.getElementById('btn').onclick = () => {
    document.getElementById('ui').style.display = 'none';
    const cameraUtils = new Camera(videoElement, {
        onFrame: async () => { await hands.send({image: videoElement}); },
        width: 480, height: 360
    });
    cameraUtils.start();
};

function animate() {
    requestAnimationFrame(animate);
    points.rotation.y += 0.01;
    renderer.render(scene, camera);
}
generateShape('random');
animate();
</script>
</body>
</html>
